
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free CV Audit | Work Waves Career Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.16/mammoth.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3b82f6; /* Blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #drop-zone {
            border: 2px dashed #4b5563; /* Gray-600 */
            transition: border-color 0.3s, background-color 0.3s;
        }
        #drop-zone.drag-over {
            border-color: #3b82f6; /* Blue-500 */
            background-color: #1f2937; /* Gray-800 */
        }
        .paypal-gateway-panel,
        .whishpay-gateway-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(17, 24, 39, 0.95));
        }
        .paypal-powered-text,
        .whishpay-powered-text {
            letter-spacing: 0.08em;
        }
    </style>
</head>
<body class="bg-gray-900 text-slate-200">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <!-- Header Section -->
        <header class="text-center mb-8 md:mb-12">
            <!-- Embedded SVG Logo -->
            <div class="mx-auto h-auto w-48 mb-6">
                 <svg viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
                    <!-- Diamond Shape -->
                    <path d="M 100 0 L 150 50 L 100 100 L 50 50 Z" fill="none" stroke="white" stroke-width="2"/>
                    <!-- Waves -->
                    <path d="M 65 40 Q 85 30, 100 40 T 135 40" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M 60 55 Q 80 45, 100 55 T 140 55" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M 68 70 Q 88 60, 103 70 T 138 70" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <!-- Text -->
                    <text x="100" y="125" font-family="Inter, sans-serif" font-size="14" font-weight="300" fill="white" text-anchor="middle" letter-spacing="4">WORK WAVES</text>
                    <text x="100" y="145" font-family="Inter, sans-serif" font-size="8" font-weight="300" fill="white" text-anchor="middle" letter-spacing="2">BY COPYARABIA</text>
                </svg>
            </div>
            
            <p class="text-lg md:text-xl text-slate-400 mt-2">Get Your Free, Instant ATS-Friendly CV Audit</p>
        </header>

        <main class="max-w-4xl mx-auto">
            <!-- Main Card -->
            <div id="main-card" class="bg-gray-800 rounded-xl shadow-lg p-6 md:p-10 border border-gray-700">

                <!-- Upload Section -->
                <div id="upload-section">
                    <h2 class="text-2xl font-bold text-center text-white mb-2">Upload Your CV</h2>
                    <p class="text-center text-slate-400 mb-6">Upload a .PDF or .DOCX file to see how an Applicant Tracking System (ATS) sees your CV.</p>

                    <div id="drop-zone" class="relative rounded-lg p-8 text-center cursor-pointer bg-gray-900 hover:border-blue-500">
                        <input type="file" id="cv-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf,.docx">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 19.5h18" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            <p class="font-semibold text-slate-300">Drag & drop your file here</p>
                            <p class="text-slate-500 text-sm mt-1">or click to browse</p>
                            <p id="file-name" class="mt-4 text-sm font-medium text-blue-400"></p>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="audit-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                            Audit My CV
                        </button>
                    </div>
                </div>

                <!-- Loading Section -->
                <div id="loading-section" class="hidden text-center py-12">
                    <div class="spinner w-12 h-12 rounded-full border-4 border-gray-700 mx-auto"></div>
                    <p id="loading-text" class="mt-6 text-lg font-medium text-slate-300">Auditing your CV...</p>
                    <p id="loading-subtext" class="text-slate-400">Our AI is analyzing your document for ATS compatibility. This may take a moment.</p>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="hidden">
                    <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-6">Your CV Audit Results</h2>
                    <div id="audit-output" class="prose prose-invert max-w-none rounded-lg bg-gray-900 p-6">
                        <!-- AI generated content will go here -->
                    </div>

                    <!-- Payment Section -->
                    <div class="mt-8 bg-gray-900 border border-blue-500/40 p-6 rounded-lg text-center">
                        <h3 class="text-xl font-bold text-white">Download Your Revised CV (PDF)</h3>
                        <p class="mt-2 text-slate-300">
                            Get the professionally revised, ATS-ready version of your CV based on this audit for
                            <span class="font-semibold text-white" id="payment-price">USD 1.99</span>.
                        </p>
                        <p class="mt-2 text-slate-400 text-sm">
                            Pay securely through PayPal, debit/credit card, or Whish Pay to unlock your download instantly.
                        </p>
                        <div class="mt-6 flex flex-col items-center gap-4">
                            <div class="paypal-gateway-panel w-full max-w-md rounded-lg p-3">
                                <div id="paypal-button-paypal" class="min-h-[44px]"></div>
                            </div>
                            <div class="paypal-gateway-panel w-full max-w-md rounded-lg p-3">
                                <div id="paypal-button-card" class="min-h-[44px]"></div>
                            </div>
                            <div class="whishpay-gateway-panel w-full max-w-md rounded-lg p-4">
                                <button id="whishpay-button" class="w-full rounded-md bg-emerald-500 py-3 text-sm font-semibold text-slate-900 transition hover:bg-emerald-400">
                                    Pay with Whish Pay
                                </button>
                                <p class="whishpay-powered-text mt-2 text-xs uppercase text-slate-400">Powered by Whish Pay</p>
                            </div>
                            <p id="whishpay-status" class="text-xs text-slate-500"></p>
                        </div>
                        <a id="download-link" href="#" class="mt-4 inline-flex items-center justify-center bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg opacity-50 pointer-events-none transition-colors" aria-disabled="true">
                            Download Revised CV (PDF)
                        </a>
                        <p id="download-note" class="mt-2 text-xs text-slate-500">Complete payment to unlock your download.</p>
                        <button id="retry-download" type="button" class="hidden mt-3 text-xs text-blue-300 hover:text-blue-200 underline">
                            Retry generating your revised CV
                        </button>
                    </div>
                </div>
                 <!-- Error Message Box -->
                <div id="error-box" class="hidden mt-4 bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="error-message"></span>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-8 md:mt-12">
            <p class="text-sm text-slate-500">&copy; 2025 Work Waves Career Services. All rights reserved.</p>
        </footer>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        const dropZone = document.getElementById('drop-zone');
        const cvUpload = document.getElementById('cv-upload');
        const auditButton = document.getElementById('audit-button');
        const fileNameDisplay = document.getElementById('file-name');

        const paypalButtonPayPalContainer = document.getElementById('paypal-button-paypal');
        const paypalButtonCardContainer = document.getElementById('paypal-button-card');
        const whishPayButton = document.getElementById('whishpay-button');
        const whishPayStatus = document.getElementById('whishpay-status');
        const downloadLink = document.getElementById('download-link');
        const downloadNote = document.getElementById('download-note');
        const retryDownloadButton = document.getElementById('retry-download');
        
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const resultsSection = document.getElementById('results-section');
        const auditOutput = document.getElementById('audit-output');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        
        let cvFile = null;
        let paypalSdkLoading = null;
        let paypalButtonsRendered = false;
        let paypalConfigCache = null;
        let paypalConfigError = null;
        let whishPayConfigCache = null;
        let extractedCvText = '';
        let extractedCvAnalysis = '';
        let revisedCvBlobUrl = null;
        let paymentCompleted = false;
        let isGeneratingPdf = false;

        const storedCvText = sessionStorage.getItem('cvText');
        if (storedCvText) {
            extractedCvText = storedCvText;
        }
        const storedCvAnalysis = sessionStorage.getItem('cvAnalysis');
        if (storedCvAnalysis) {
            extractedCvAnalysis = storedCvAnalysis;
        }

        const storedPaymentCompleted = sessionStorage.getItem('paymentCompleted');
        if (storedPaymentCompleted === 'true') {
            paymentCompleted = true;
        }

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        cvUpload.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        
        function handleFile(file) {
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (file && allowedTypes.includes(file.type)) {
                cvFile = file;
                fileNameDisplay.textContent = file.name;
                auditButton.disabled = false;
                hideError();
            } else {
                cvFile = null;
                fileNameDisplay.textContent = '';
                auditButton.disabled = true;
                showError("Invalid file type. Please upload a PDF or DOCX file.");
            }
        }
        
        auditButton.addEventListener('click', async () => {
            if (!cvFile) return;

            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            hideError();
            setDownloadLocked(true);

            try {
                let text = '';
                if (cvFile.type === 'application/pdf') {
                    text = await extractTextFromPdf(cvFile);
                } else {
                    text = await extractTextFromDocx(cvFile);
                }

                if (text.trim().length < 50) {
                   throw new Error("Could not extract enough text. The file might be empty, corrupted, or image-based.");
                }

                extractedCvText = text;
                sessionStorage.setItem('cvText', text);
                const auditResult = await getAuditFeedback(text);
                extractedCvAnalysis = auditResult;
                sessionStorage.setItem('cvAnalysis', auditResult);
                auditOutput.innerHTML = auditResult.replace(/\n\n/g, '<p>').replace(/\n/g, '<br>');
                loadingSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                initializePayPalButtons();
                initializeWhishPayCheckout();

            } catch (error) {
                console.error('Audit Error:', error);
                loadingSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                showError(error.message || "An unexpected error occurred during the audit.");
            }
        });

        async function extractTextFromPdf(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (event) => {
                    try {
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ');
                        }
                        resolve(text);
                    } catch (error) { reject(new Error("Could not read the PDF. It may be corrupted.")); }
                };
                reader.onerror = () => reject(new Error("Failed to read the file."));
                reader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromDocx(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (event) => {
                    try {
                        const { value } = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                        resolve(value);
                    } catch (error) { reject(new Error("Could not read the DOCX file. It may be corrupted.")); }
                };
                reader.onerror = () => reject(new Error("Failed to read the file."));
                reader.readAsArrayBuffer(file);
            });
        }

        // --- SECURE API CALL to our Netlify Function ---
        async function getAuditFeedback(cvText) {
            // FIX: The backend function only exists when deployed.
            // This check now returns a mock response in preview environments instead of throwing an error.
            
            // This URL points to our secure backend function. It will work correctly once deployed.
            const functionUrl = '/.netlify/functions/audit';

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cvText: cvText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.audit || result.auditResult;

            } catch (error) {
                 console.error("Function call error:", error);
                 if (error instanceof SyntaxError) {
                     throw new Error("Received an invalid response from the server. This can happen if the backend function has an error.");
                 }
                 throw new Error(error.message || "Could not connect to the audit service.");
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }

        function setDownloadLocked(isLocked) {
            if (!downloadLink || !downloadNote) return;
            if (isLocked) {
                downloadLink.classList.add('opacity-50', 'pointer-events-none');
                downloadLink.setAttribute('aria-disabled', 'true');
                downloadLink.setAttribute('href', '#');
                downloadLink.removeAttribute('download');
                if (revisedCvBlobUrl) {
                    URL.revokeObjectURL(revisedCvBlobUrl);
                    revisedCvBlobUrl = null;
                }
                downloadNote.textContent = 'Complete payment to unlock your download.';
            } else {
                downloadLink.classList.remove('opacity-50', 'pointer-events-none');
                downloadLink.setAttribute('aria-disabled', 'false');
                if (revisedCvBlobUrl) {
                    downloadLink.href = revisedCvBlobUrl;
                }
                downloadLink.setAttribute('download', 'revised-cv.pdf');
                downloadNote.textContent = 'Your revised CV PDF is ready to download.';
            }
            updateRetryVisibility();
        }

        function updateRetryVisibility() {
            if (!retryDownloadButton) return;
            if (paymentCompleted && !revisedCvBlobUrl && !isGeneratingPdf) {
                retryDownloadButton.classList.remove('hidden');
                if (downloadNote) {
                    downloadNote.textContent = 'Payment received. Generate your revised CV to download.';
                }
            } else {
                retryDownloadButton.classList.add('hidden');
            }
        }

        async function generateRevisedPdf(cvText) {
            if (!cvText) {
                throw new Error('Unable to generate the revised CV. Please run the audit again.');
            }
            if (isGeneratingPdf) return;
            isGeneratingPdf = true;
            downloadNote.textContent = 'Preparing your revised CV PDF...';
            updateRetryVisibility();
            try {
                const cvAnalysis = extractedCvAnalysis || sessionStorage.getItem('cvAnalysis') || '';
                const response = await fetch('/.netlify/functions/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cvText, cvAnalysis }),
                });

                if (!response.ok) {
                    let message = 'Unable to generate the revised CV.';
                    try {
                        const errorData = await response.json();
                        if (errorData?.error) {
                            message = errorData.error;
                        }
                    } catch (parseError) {
                        console.warn('Generate PDF error response could not be parsed.', parseError);
                    }
                    throw new Error(message);
                }

                const pdfBlob = await response.blob();
                if (revisedCvBlobUrl) {
                    URL.revokeObjectURL(revisedCvBlobUrl);
                }
                revisedCvBlobUrl = URL.createObjectURL(pdfBlob);
                downloadLink.href = revisedCvBlobUrl;
                downloadLink.setAttribute('download', 'revised-cv.pdf');
            } finally {
                isGeneratingPdf = false;
                updateRetryVisibility();
            }
        }

        async function fetchPayPalConfig() {
            if (paypalConfigCache) return paypalConfigCache;
            const response = await fetch('/.netlify/functions/paypal-config');
            if (!response.ok) {
                let errorMessage = 'Unable to load PayPal configuration.';
                if (response.status === 404) {
                    errorMessage = 'PayPal checkout is unavailable here. Run Netlify dev or deploy the site to enable serverless functions.';
                } else {
                    try {
                        const errorData = await response.json();
                        if (errorData?.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.warn('PayPal config error response could not be parsed.', parseError);
                    }
                }
                const error = new Error(errorMessage);
                paypalConfigError = error;
                throw error;
            }
            paypalConfigCache = await response.json();
            return paypalConfigCache;
        }

        async function hydratePayPalPricing() {
            try {
                const config = await fetchPayPalConfig();
                const formattedPrice = `${config.currency || 'USD'} ${config.amount || '1.99'}`;
                const priceElements = [
                    document.getElementById('payment-price'),
                ];
                priceElements.forEach((element) => {
                    if (element) element.textContent = formattedPrice;
                });
            } catch (error) {
                console.warn('PayPal pricing unavailable:', error);
                if (downloadNote) {
                    downloadNote.textContent = 'PayPal checkout is unavailable right now. Please try again later.';
                }
                if (paypalButtonPayPalContainer) {
                    paypalButtonPayPalContainer.innerHTML = '<p class="text-sm text-slate-400">PayPal checkout is currently unavailable.</p>';
                }
                if (paypalButtonCardContainer) {
                    paypalButtonCardContainer.innerHTML = '';
                }
            }
        }

        async function loadPayPalSdk() {
            if (paypalSdkLoading) return paypalSdkLoading;
            paypalSdkLoading = (async () => {
                try {
                    const config = await fetchPayPalConfig();
                    if (!config?.clientId) {
                        throw new Error('PayPal is not configured yet.');
                    }
                    if (window.paypal) return window.paypal;
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        const params = new URLSearchParams({
                            'client-id': config.clientId,
                            currency: config.currency || 'USD',
                            intent: 'capture',
                            'enable-funding': 'card',
                            'disable-funding': 'paylater',
                        });
                        script.src = `https://www.paypal.com/sdk/js?${params.toString()}`;
                        script.async = true;
                        script.onload = () => resolve();
                        script.onerror = () => reject(new Error('Failed to load the PayPal SDK.'));
                        document.head.appendChild(script);
                    });
                    return window.paypal;
                } catch (error) {
                    paypalSdkLoading = null;
                    throw error;
                }
            })();
            return paypalSdkLoading;
        }

        async function initializePayPalButtons() {
            if (!paypalButtonPayPalContainer || !paypalButtonCardContainer || paypalButtonsRendered) return;
            try {
                const paypalSdk = await loadPayPalSdk();
                const createOrder = async () => {
                    const response = await fetch('/.netlify/functions/paypal-create-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({}),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Unable to create PayPal order.');
                    }
                    const orderData = await response.json();
                    return orderData.id;
                };

                const handleApprove = async (data) => {
                    try {
                        const response = await fetch('/.netlify/functions/paypal-capture-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderID: data.orderID }),
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Unable to capture PayPal order.');
                        }
                        const captureResult = await response.json();
                        if (captureResult.status === 'COMPLETED') {
                            paymentCompleted = true;
                            sessionStorage.setItem('paymentCompleted', 'true');
                            try {
                                await generateRevisedPdf(extractedCvText);
                                setDownloadLocked(false);
                            } catch (error) {
                                console.error('PDF generation error:', error);
                                showError(error.message || 'Unable to generate your revised CV yet.');
                                updateRetryVisibility();
                            }
                        } else {
                            showError('Payment is still processing. Please wait for confirmation.');
                        }
                    } catch (error) {
                        console.error('PayPal capture error:', error);
                        showError(error.message || 'Unable to finalize payment. Please try again.');
                    }
                };

                const baseButtonConfig = {
                    style: {
                        layout: 'vertical',
                        color: 'gold',
                        shape: 'rect',
                        height: 48,
                    },
                    createOrder,
                    onApprove: handleApprove,
                    onError: (error) => {
                        console.error('PayPal error:', error);
                        showError(error.message || 'PayPal checkout failed. Please try again.');
                    },
                };

                const paypalButtons = paypalSdk.Buttons({
                    ...baseButtonConfig,
                    fundingSource: paypalSdk.FUNDING.PAYPAL,
                    style: {
                        ...baseButtonConfig.style,
                        label: 'pay',
                    },
                });

                const cardButtons = paypalSdk.Buttons({
                    ...baseButtonConfig,
                    fundingSource: paypalSdk.FUNDING.CARD,
                    style: {
                        ...baseButtonConfig.style,
                        color: 'black',
                        label: 'pay',
                    },
                });

                await paypalButtons.render('#paypal-button-paypal');
                if (cardButtons.isEligible()) {
                    await cardButtons.render('#paypal-button-card');
                } else if (paypalButtonCardContainer) {
                    paypalButtonCardContainer.innerHTML = '<p class="text-xs text-slate-500">Card checkout is not available in this region.</p>';
                }
                paypalButtonsRendered = true;
            } catch (error) {
                console.error('PayPal setup error:', error);
                paypalButtonsRendered = false;
                showError(error.message || 'PayPal is not available right now.');
            }
        }

        async function fetchWhishPayConfig() {
            if (whishPayConfigCache) return whishPayConfigCache;
            const response = await fetch('/.netlify/functions/whishpay-config');
            if (!response.ok) {
                let errorMessage = 'Unable to load Whish Pay configuration.';
                if (response.status === 404) {
                    errorMessage = 'Whish Pay checkout is unavailable here. Run Netlify dev or deploy the site to enable serverless functions.';
                } else {
                    try {
                        const errorData = await response.json();
                        if (errorData?.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.warn('Whish Pay config error response could not be parsed.', parseError);
                    }
                }
                throw new Error(errorMessage);
            }
            whishPayConfigCache = await response.json();
            return whishPayConfigCache;
        }

        async function hydrateWhishPayPricing() {
            try {
                const config = await fetchWhishPayConfig();
                const formattedPrice = `${config.currency || 'USD'} ${config.amount || '1.99'}`;
                const priceElements = [
                    document.getElementById('payment-price'),
                ];
                priceElements.forEach((element) => {
                    if (element) element.textContent = formattedPrice;
                });
            } catch (error) {
                console.warn('Whish Pay pricing unavailable:', error);
                if (downloadNote) {
                    downloadNote.textContent = 'Whish Pay checkout is unavailable right now. Please try again later.';
                }
                if (whishPayStatus) {
                    whishPayStatus.textContent = 'Whish Pay checkout is currently unavailable.';
                }
                if (whishPayButton) {
                    whishPayButton.disabled = true;
                    whishPayButton.classList.add('cursor-not-allowed', 'opacity-60');
                }
            }
        }

        async function startWhishPayCheckout() {
            if (!whishPayButton) return;
            whishPayButton.disabled = true;
            whishPayButton.classList.add('opacity-70');
            if (whishPayStatus) {
                whishPayStatus.textContent = 'Opening Whish Pay checkout...';
            }

            try {
                const config = await fetchWhishPayConfig();
                const externalId = Date.now();
                sessionStorage.setItem('whishPayExternalId', externalId.toString());
                const returnQuery = `payment=success&externalId=${externalId}`;
                const failQuery = `payment=failed&externalId=${externalId}`;
                const response = await fetch('/.netlify/functions/whishpay-create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: config.amount,
                        currency: config.currency,
                        invoice: 'Revised CV download',
                        externalId,
                        successCallbackUrl: `${window.location.origin}${window.location.pathname}?${returnQuery}`,
                        failureCallbackUrl: `${window.location.origin}${window.location.pathname}?${failQuery}`,
                        successRedirectUrl: `${window.location.origin}${window.location.pathname}?${returnQuery}`,
                        failureRedirectUrl: `${window.location.origin}${window.location.pathname}?${failQuery}`,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Unable to create Whish Pay checkout.');
                }

                const payload = await response.json();
                const paymentUrl = payload?.data?.collectUrl || payload?.collectUrl;
                if (!paymentUrl) {
                    throw new Error('Whish Pay did not return a checkout link.');
                }
                window.location.href = paymentUrl;
            } catch (error) {
                console.error('Whish Pay error:', error);
                showError(error.message || 'Whish Pay checkout failed. Please try again.');
            } finally {
                whishPayButton.disabled = false;
                whishPayButton.classList.remove('opacity-70');
            }
        }

        function handleWhishPayReturn() {
            const url = new URL(window.location.href);
            const paymentStatus = url.searchParams.get('payment');
            if (!paymentStatus) return;
            if (paymentStatus === 'success') {
                const externalId = url.searchParams.get('externalId') || sessionStorage.getItem('whishPayExternalId');
                if (!externalId) {
                    showError('Missing Whish Pay reference. Please try again.');
                    return;
                }
                if (whishPayStatus) {
                    whishPayStatus.textContent = 'Confirming Whish Pay payment...';
                }
                fetch('/.netlify/functions/whishpay-check-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ externalId, currency: 'USD' }),
                })
                    .then(async (response) => {
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Unable to confirm Whish Pay payment.');
                        }
                        return response.json();
                    })
                    .then((statusData) => {
                        if (statusData.collectStatus !== 'success') {
                            throw new Error('Whish Pay payment is not confirmed yet.');
                        }
                        paymentCompleted = true;
                        sessionStorage.setItem('paymentCompleted', 'true');
                        sessionStorage.removeItem('whishPayExternalId');
                        if (whishPayStatus) {
                            whishPayStatus.textContent = 'Payment confirmed. Preparing your download...';
                        }
                        return generateRevisedPdf(extractedCvText);
                    })
                    .then(() => setDownloadLocked(false))
                    .catch((error) => {
                        console.error('Whish Pay confirmation error:', error);
                        showError(error.message || 'Unable to confirm your payment yet.');
                        updateRetryVisibility();
                    });
            } else {
                if (whishPayStatus) {
                    whishPayStatus.textContent = 'Payment was cancelled or failed. Please try again.';
                }
            }
            url.searchParams.delete('payment');
            url.searchParams.delete('externalId');
            window.history.replaceState({}, document.title, url.toString());
        }

        function initializeWhishPayCheckout() {
            if (whishPayButton) {
                whishPayButton.addEventListener('click', startWhishPayCheckout);
            }
        }

        hydratePayPalPricing();
        hydrateWhishPayPricing();
        updateRetryVisibility();
        handleWhishPayReturn();

        if (retryDownloadButton) {
            retryDownloadButton.addEventListener('click', async () => {
                try {
                    await generateRevisedPdf(extractedCvText);
                    setDownloadLocked(false);
                } catch (error) {
                    console.error('Retry PDF generation error:', error);
                    showError(error.message || 'Unable to generate your revised CV yet.');
                    updateRetryVisibility();
                }
            });
        }
    </script>
</body>
</html>
